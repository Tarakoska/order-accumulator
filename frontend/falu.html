<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Rendelés agregátor</title>
  <link rel="stylesheet" href="./styles.css">
  <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.6.1/socket.io.min.js" integrity="sha512-AI5A3zIoeRSEEX9z3Vyir8NqSMC1pY7r5h2cE+9J6FLsoEmSSGLFaqMQw8SWvoONXogkfFrkQiJfLeHLz3+HOg==" crossorigin="anonymous"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-KK94CHFLLe+nY2dmCWGMq91rCGa5gtU4mk92HdvYe+M/SXH301p5ILy+dN9+nJOZ" crossorigin="anonymous">
</head>
<header class="row">
  <div class="col-6 text-start">
    <h1>Falusi rendelő</h1>
  </div>
  <div class="col-6 text-end user-info">
    <span id="username-display"></span>
    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-pen" viewBox="0 0 16 16" data-darkreader-inline-fill="" style="--darkreader-inline-fill:currentColor;">
      <path d="m13.498.795.149-.149a1.207 1.207 0 1 1 1.707 1.708l-.149.148a1.5 1.5 0 0 1-.059 2.059L4.854 14.854a.5.5 0 0 1-.233.131l-4 1a.5.5 0 0 1-.606-.606l1-4a.5.5 0 0 1 .131-.232l9.642-9.642a.5.5 0 0 0-.642.056L6.854 4.854a.5.5 0 1 1-.708-.708L9.44.854A1.5 1.5 0 0 1 11.5.796a1.5 1.5 0 0 1 1.998-.001zm-.644.766a.5.5 0 0 0-.707 0L1.95 11.756l-.764 3.057 3.057-.764L14.44 3.854a.5.5 0 0 0 0-.708l-1.585-1.585z"></path>
    </svg>
  </div>
</header>
<body>
  <div class="popup" id="popup">
    <div class="popup-inner">
      <h2>Kélek írd be hogyan hívnak:</h2>
      <input type="text" id="username-input">
      <br><br>
      <button onclick="saveUsername()">Mentés</button>
      <button onclick="closePopup()">Mégse</button>
    </div>
  </div>
  <div class="popup" id="psid-popup">
    <div class="popup-inner">
      <h2>Írd be a falusi oldalon lévő PHPSESSIONID-det:</h2>
      <input type="text" id="psid-input">
      <br><br>
      <button onclick="transferBasketToFalusi()">Áthelyezés</button>
      <button onclick="closePSIDPopup()">Mégse</button>
    </div>
  </div>

  <div class="layout">
    <div class="list-container etlaplist">
      <div class="container">
        <div class="row">
          <h2>Étlap</h2>
        </div>
      </div>
      <div class="row">
        <ul class="list" id="foodList"></ul>
      </div>
    </div>
    <div class="list-container localbasket">
      <div class="container">
        <div class="row">
          <div class="col-12">
            <h2>Kosarad</h2>
          </div>
        </div>
        <div class="row">
          <div class="col-6 text-start">
            <span id="localbasket-value"></span>
          </div>
          <div class="col-6 text-end">
            <button id="clearBasketButton">Kosarad kiürétése</button>
          </div>
        </div>
        <div class="row">
          <ul class="list" id="basketList"></ul>
        </div>
      </div>
    </div>
    <div class="list-container globalbasket">
      <div class="container">
        <div class="row">
          <div class="col-12">
            <h2>Közös kosár</h2>
          </div>
        </div>
        <div class="row">
          <div class="col-6 text-start">
            <span id="globalbasket-value"></span>
          </div>
          <div class="col-6 text-end">
            <button id="transferBasketButton">Megrendelés</button>
          </div>
        </div>
        <div class="row">
          <ul class="list" id="globalbasketList"></ul>
        </div>
      </div>
    </div>
  </div>
  <script>
    function saveUsername() {
      let user = document.getElementById("username-input").value;
      if (user !== "") {
        document.cookie = `username=${encodeURIComponent(user)}; expires=${getCookieExpirationDate(14)}`;
        closePopup();
        username = user;
        displayUsername(username);
      }
    }

    function transferBasketToFalusi() {
      let psid = document.getElementById("psid-input").value;
      if (psid !== "") {
        closePSIDPopup();
        fetch(`http://${window.location.hostname}/api/transferBasket`,{
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ psid: psid })
        })
          .then(response => {
            console.log(response.statusText);
            if (response.statusText == "OK") {
              alert("Kosár sikeresen átmásolva a falusira. Frissítsd a dalusi oldalát.")
            } else {
              alert("Valami hiba történt.")
            }
          })
            .catch(error => console.error(error))
      }
    }

    function displayUsername(username) {
      let usernameDisplay = document.getElementById("username-display");
      usernameDisplay.addEventListener('click', () => { openPopup() });
      usernameDisplay.innerHTML = "Hello, " + username + "!";
      usernameDisplay.style.display = "block";
    }

    function closePopup() {
      if (username !== "" || username === null) {
        let popup = document.getElementById("popup");
        popup.style.display = "none";
      }
    }

    function openPopup() {
      let popup = document.getElementById("popup");
      popup.style.display = "block";
    }

    function closePSIDPopup() {
      if (username !== "" || username === null) {
        let popup = document.getElementById("psid-popup");
        popup.style.display = "none";
      }
    }

    function openPSIDPopup() {
      let popup = document.getElementById("psid-popup");
      popup.style.display = "block";
    }

    function getUsernameFromCookie() {
      let cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        let cookie = cookies[i].trim();
        if (cookie.startsWith("username=")) {
          return decodeURIComponent(cookie.substring("username=".length));
        }
      }
      return null;
    }

    let username = getUsernameFromCookie();
    if (username !== null) {
      displayUsername(username);
    } else {
      openPopup();
    }


    function getBasketFromCookies() {
     const basketString = document.cookie.replace(/(?:(?:^|.*;\s*)basket\s*\=\s*([^;]*).*$)|^.*$/, '$1');
     return basketString ? JSON.parse(basketString) : null;
   }

   function setBasketInCookies(basket) {
     const basketString = JSON.stringify(basket);
     document.cookie = `basket=${basketString}; path=/; expires=${getCookieExpirationDate(7)}`;
   }

    function getCookieExpirationDate(days) {
      const date = new Date();
      date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
      return date.toUTCString();
    }

    function updateBasketList() {
      const basketList = document.getElementById('basketList');
      const localvalue = document.getElementById("localbasket-value");
      // Clear the current list
      basketList.innerHTML = '';
      const basket = getBasketFromCookies();
      socket.emit("Server Basket Update", { [username]: basket });
      if (!basket) {
        localvalue.innerText = "0 Ft"
        return;
      }

      console.log("Basket item list");
      console.log(basket);
      let localBasketValue = 0;
      // Loop through the basket items and add them to the list
      Object.entries(basket).forEach(([itemSizeKey, item]) => {
      // for (let item of basketItems) {
        const listItem = document.createElement('li');
        const deleteButton = document.createElement('button');
        const quantitySpan = document.createElement('span');
        deleteButton.innerText = 'Töröl';

        // Add an event listener to the delete button to remove the item from the basket
        deleteButton.addEventListener('click', () => {
          const basketItem = item;
          if (basketItem.quantity == 1) {
            // Otherwise, add a new entry to the basket
            delete basket[itemSizeKey]
          } else {
            // If the item already exists in the basket, increment the quantity
            basketItem.quantity -= 1;
          }
          setBasketInCookies(basket);

          updateBasketList();
        });
        localBasketValue += Number(item.quantity) * Number(item.price.split(' ')[0])
        quantitySpan.innerText = `${item.quantity} x `;
        listItem.innerText = `${item.name} (${item.size}) - ${item.price}`;
        listItem.insertBefore(quantitySpan, listItem.firstChild);
        listItem.appendChild(deleteButton);
        basketList.appendChild(listItem);
      });

      localvalue.innerText = localBasketValue + " Ft"

    }

    function updateGlobalBasketList(globalBasket) {
      const globalbasketList = document.getElementById('globalbasketList');
      // Clear the current list
      globalbasketList.innerHTML = '';
      // const basket = getBasketFromCookies();

      if (!globalBasket) {
        return;
      }

      console.log("Global Basket item list");
      console.log(globalBasket);
      let globalBasketValue = 0;
      // Loop through the basket items and add them to the list
      Object.entries(globalBasket).forEach(([person, basket]) => {
        console.log(person + " in globalBasket");
        console.log(person + "'s baskets: " + JSON.stringify(basket, null, 4));
        if (!basket || Object.entries(basket).length === 0) {
          return;
        }
        const personItem = document.createElement('ul');
        personItem.classList.add("list");
        const headerItem = document.createElement('li');
        const usernameItem = document.createElement('span');
        usernameItem.innerText = person;
        const userPriceSumItem = document.createElement('span');
        const basketItem = document.createElement('li');

        const userBasketItem = document.createElement('ul');
        userBasketItem.classList.add("list");
        var priceSum = 0;
        Object.entries(basket).forEach(([id, item]) => {
          const listItem = document.createElement('li');
          const quantitySpan = document.createElement('span');
          const nameSpan = document.createElement('span');
          priceSum += Number(item.quantity) * Number((item.price).split(' ')[0]);
          quantitySpan.innerText = `${item.quantity} x `;
          nameSpan.innerText = `${item.name} (${item.size}) - ${item.price}`;
          listItem.appendChild(quantitySpan);
          listItem.appendChild(nameSpan);
          userBasketItem.appendChild(listItem);
        });
        userPriceSumItem.innerText = priceSum + ' Ft';

        globalBasketValue += priceSum;
        headerItem.insertBefore(usernameItem, personItem.firstChild);
        headerItem.appendChild(userPriceSumItem);
        basketItem.appendChild(userBasketItem);
        personItem.appendChild(headerItem);
        personItem.appendChild(basketItem);
        globalbasketList.appendChild(personItem);
      });
      const globalvalue = document.getElementById("globalbasket-value");
      globalvalue.innerText = globalBasketValue + " Ft"
    }

    function createListItem(item) {
      const listItem = document.createElement('li');
      listItem.classList.add('item');

      const nameLabel = document.createElement('span');
      nameLabel.classList.add('name');
      nameLabel.innerText = item.label;
      listItem.appendChild(nameLabel);

      const buttonContainer = document.createElement('div');
      buttonContainer.classList.add('button-container');
      listItem.appendChild(buttonContainer);

      // Add a button for each size
      item.sizes.forEach(size => {
        const sizeButton = document.createElement('button');
        sizeButton.classList.add('size');
        sizeButton.innerText = size.label;
        buttonContainer.appendChild(sizeButton);

        // Add an event listener to update the basket and save it to cookies
        sizeButton.addEventListener('click', () => {
          const basket = getBasketFromCookies() || {};
          console.log("Add to basket");
          console.log(basket);

          const itemSizeKey = `${item.id}-${size.size}`;
          if (basket[itemSizeKey]) {
            // If the item already exists in the basket, increment the quantity
            basket[itemSizeKey].quantity += 1;
          } else {
            // Otherwise, add a new entry to the basket
            basket[itemSizeKey] = {
              id: item.id,
              name: item.label,
              size: size.size,
              price: size.price,
              link: size.link,
              quantity: 1
            };
          }
          setBasketInCookies(basket);

          updateBasketList();
        });
      });

      return listItem;
    }

    const clearBasketButton = document.getElementById('clearBasketButton');

    clearBasketButton.addEventListener('click', () => {
      // Remove the basket cookie
      document.cookie = 'basket=; path=/; expires=Thu, 01 Jan 1970 00:00:00 UTC';
      updateBasketList();
    });

    const transferBasketButton = document.getElementById('transferBasketButton');

    transferBasketButton.addEventListener('click', () => {
      openPSIDPopup();
    });

    var socket;

    fetch(`http://${window.location.hostname}/api/getetlap`)
      .then(response => response.json())
        .then(data => {

          const listContainer = document.getElementById('foodList');

          data.forEach(item => {
            listContainer.appendChild(createListItem(item));
          });
          updateBasketList()

        })
      .catch(error => console.error(error));


    $(document).ready(function(){
      // sending a connect request to the server.
      socket = io.connect();

      socket.on('connect', function() {
        console.log('Socket.IO connection established');
      });


      socket.on('Client Basket Update', function(msg) {
        console.log('Global basket incomming via websocket: ', msg);
        updateGlobalBasketList(msg.basket);
      });
    });
  </script>

</body>
</html>
